#!/usr/bin/env bash
# direnv-init-1password - Initialize direnv with 1Password integration
# Works from any shell (bash/zsh/fish) due to shebang

set -euo pipefail

# shellcheck source=direnv-lib
source "$(dirname "$0")/direnv-lib"

# Check if op CLI is installed
if ! command -v op >/dev/null 2>&1; then
    error "1Password CLI (op) not installed"
    info "Install: brew install --cask 1password-cli"
    info "Or visit: https://developer.1password.com/docs/cli/get-started/"
    exit 1
fi

# Check if authenticated
if ! op account list >/dev/null 2>&1; then
    error "Not authenticated with 1Password"
    info "Run: eval \$(op signin)"
    exit 1
fi

check_direnv
handle_existing_envrc

# Check if .oprc exists
if [[ -f .oprc ]]; then
    info ".oprc already exists"
else
    # Create sample .oprc
    cat > .oprc << 'EOF'
# .oprc - 1Password secret references
# Add to .gitignore to keep secret references out of version control

# Example secret references (update with your vault/item/field names):
# DATABASE_URL=op://vault-name/database/connection-url
# API_KEY=op://vault-name/api-credentials/api-key
# JWT_SECRET=op://vault-name/auth/jwt-secret

# Add your secrets below:

EOF
    success ".oprc created with examples"
fi

# Create .envrc with layout auto (which now handles .oprc loading)
echo "Creating .envrc with 1Password integration"
write_envrc '# Automatically load .env and 1Password secrets
layout auto'

success ".envrc created"

# Add .oprc to .gitignore if it exists
if [[ -f .gitignore ]]; then
    if ! grep -q "^.oprc$" .gitignore 2>/dev/null; then
        echo ".oprc" >> .gitignore
        success "Added .oprc to .gitignore"
    fi
else
    echo ".oprc" > .gitignore
    success "Created .gitignore with .oprc"
fi

echo
success "1Password integration initialized!"
echo
info "Next steps:"
info "1. Edit .oprc and add your secret references (op://vault/item/field)"
info "2. Test: cd . to reload environment"
info "3. Verify: echo \$YOUR_SECRET_VAR"
