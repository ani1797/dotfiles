#!/usr/bin/env bash

if has mise; then
    use_mise() {
        direnv_load mise direnv exec
    }
fi

layout_mpython() {
    dotenv_if_exists .env
    watch_file requirements.txt
    use mise
    # run mise which python --version to get the python version to use, if the command fails, use the default python.
    # don't output the command to the console
    if mise which python --version > /dev/null; then
        pyversion=$(mise which python --version)
    else
        # check if mise list -mc --no-header lists a python version and if "missing" is not in the output
        if mise list -mc --no-header | grep -q python | grep -q missing; then
            log_error "No python version found in mise, please ensure you have a python version listed in mise config"
        else
            pyversion=$(mise list -mc --no-header | grep python | awk '{print $2}')
            mise use "python@$pyversion"
        fi
    fi
    log_status "Using python version: $pyversion"

    test -d .venv || python -m venv .venv
    # shellcheck disable=SC1091
    . .venv/bin/activate 
    export PYTHONPATH=.

    # check and see if there is an existing requirements checksum file
    if [ -f .mise/.reqsum ]; then
        reqsum=$(cat .mise/.reqsum)
        if [ "$reqsum" != "$(md5sum requirements.txt)" ]; then
            log_status "requirements.txt has changed, updating dependencies"
            pip install -r requirements.txt
            md5sum requirements.txt > .mise/.reqsum
        fi
    elif [ -f requirements.txt ]; then
        log_status "Running pip install -r requirements.txt to install dependencies"
        pip install -r requirements.txt
        md5sum requirements.txt > .mise/.reqsum
    else
        log_status "No requirements.txt file found, skipping pip install"
    fi
}