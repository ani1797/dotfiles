#!/usr/bin/env bash
# configure-wayvnc - Setup WayVNC with PAM authentication and TLS encryption
# Generates TLS certificates and creates secure configuration file

set -euo pipefail

# ============================================================================
# CONSTANTS
# ============================================================================

readonly CONFIG_DIR="${HOME}/.config/wayvnc"
readonly CONFIG_FILE="${CONFIG_DIR}/config"
readonly EXAMPLE_FILE="${CONFIG_DIR}/config.example"
readonly TLS_KEY="${CONFIG_DIR}/tls_key.pem"
readonly TLS_CERT="${CONFIG_DIR}/tls_cert.pem"
readonly RSA_KEY="${CONFIG_DIR}/rsa_key.pem"
readonly GITIGNORE_FILE="${CONFIG_DIR}/.gitignore"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ============================================================================
# LOGGING FUNCTIONS
# ============================================================================

info() {
    echo -e "${BLUE}[configure-wayvnc]${NC} $*"
}

success() {
    echo -e "${GREEN}✓${NC} $*"
}

error() {
    echo -e "${RED}✗${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}!${NC} $*"
}

# ============================================================================
# DEPENDENCY CHECKING
# ============================================================================

check_dependencies() {
    info "Checking dependencies..."

    local missing_deps=()

    # Check for wayvnc
    if ! command -v wayvnc &> /dev/null; then
        missing_deps+=("wayvnc")
    fi

    # Check for openssl
    if ! command -v openssl &> /dev/null; then
        missing_deps+=("openssl")
    fi

    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing required dependencies: ${missing_deps[*]}"
        info "Please install them using your package manager:"
        info "  sudo pacman -S ${missing_deps[*]}"
        exit 1
    fi

    success "All dependencies found"
}

verify_pam_support() {
    info "Verifying PAM support in wayvnc..."

    if ldd "$(which wayvnc)" 2>/dev/null | grep -q libpam; then
        success "PAM support detected in wayvnc"
        return 0
    else
        error "Your wayvnc installation does not have PAM support"
        error "PAM authentication will not work"
        warn "Consider reinstalling wayvnc with PAM support enabled"

        # Ask if user wants to continue anyway
        echo
        read -rp "Continue anyway? (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Aborted by user"
            exit 0
        fi
    fi
}

# ============================================================================
# CONFIGURATION
# ============================================================================

check_existing_config() {
    if [ -f "$CONFIG_FILE" ]; then
        warn "Configuration file already exists: $CONFIG_FILE"
        echo
        read -rp "Reconfigure? This will backup the existing config. (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Keeping existing configuration"
            exit 0
        fi

        # Backup existing config
        local backup="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$CONFIG_FILE" "$backup"
        success "Backed up existing config to: $backup"
    fi

    if [ -f "$TLS_KEY" ] || [ -f "$TLS_CERT" ]; then
        warn "Existing TLS certificates found"
        echo
        read -rp "Regenerate certificates? (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Keeping existing certificates"
            return 1
        fi

        # Backup existing certificates
        if [ -f "$TLS_KEY" ]; then
            local key_backup="${TLS_KEY}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$TLS_KEY" "$key_backup"
        fi
        if [ -f "$TLS_CERT" ]; then
            local cert_backup="${TLS_CERT}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$TLS_CERT" "$cert_backup"
        fi
        success "Backed up existing certificates"
    fi

    return 0
}

prompt_network_config() {
    echo >&2
    info "Network Configuration" >&2
    echo >&2
    echo "Choose binding address:" >&2
    echo "  1) 0.0.0.0 (all interfaces - RECOMMENDED for LAN access)" >&2
    echo "     Allows VNC connections from other machines on the network" >&2
    echo "  2) 127.0.0.1 (localhost only)" >&2
    echo "     Remote access only via SSH tunnel: ssh -L 5900:localhost:5900 user@host" >&2
    echo >&2

    local address="0.0.0.0"
    read -rp "Enter choice [1]: " choice </dev/tty

    if [ "$choice" = "2" ]; then
        address="127.0.0.1"
        info "Using localhost binding (SSH tunnel required for remote access)" >&2
    else
        success "Binding to all interfaces for LAN access" >&2
        warn "Ensure your firewall is configured properly!" >&2
    fi

    echo >&2
    read -rp "Enter VNC port [5900]: " port </dev/tty
    port=${port:-5900}

    echo "$address $port"
}

# ============================================================================
# TLS CERTIFICATE GENERATION
# ============================================================================

generate_certificates() {
    info "Generating TLS certificates..."

    # Ensure config directory exists
    mkdir -p "$CONFIG_DIR"

    # Build SAN list including local network IPs for LAN access
    local san_list="DNS:localhost,IP:127.0.0.1"

    if command -v ip &>/dev/null; then
        local local_ips
        local_ips=$(ip -4 addr show 2>/dev/null | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | sort -u)
        if [ -n "$local_ips" ]; then
            while IFS= read -r addr; do
                san_list="${san_list},IP:${addr}"
                info "  Including LAN IP in certificate: $addr"
            done <<< "$local_ips"
        fi
    fi

    local hostname_fqdn
    hostname_fqdn=$(hostname -f 2>/dev/null || hostname)
    if [ "$hostname_fqdn" != "localhost" ]; then
        san_list="${san_list},DNS:${hostname_fqdn}"
    fi

    # Generate elliptic curve certificate (modern, secure, fast)
    if openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:secp384r1 \
        -sha384 -days 3650 -nodes \
        -keyout "$TLS_KEY" \
        -out "$TLS_CERT" \
        -subj /CN=localhost \
        -addext "subjectAltName=${san_list}" 2>/dev/null; then

        success "TLS certificates generated successfully"
        success "  Private key: $TLS_KEY"
        success "  Certificate: $TLS_CERT"
        success "  Valid for: 10 years"
    else
        error "Failed to generate TLS certificates"
        exit 1
    fi
}

# ============================================================================
# RSA KEY GENERATION
# ============================================================================

generate_rsa_key() {
    info "Generating RSA key for RSA-AES encryption..."

    if [ -f "$RSA_KEY" ]; then
        # Check if existing key is in the correct PKCS#1 format
        if head -1 "$RSA_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            success "RSA key already exists in correct format: $RSA_KEY"
            return 0
        else
            warn "Existing RSA key is in wrong format (PKCS#8), regenerating..."
            local backup="${RSA_KEY}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$RSA_KEY" "$backup"
        fi
    fi

    # Generate RSA key in PKCS#1 format (required by neatvnc)
    # OpenSSL 3.x defaults to PKCS#8 format, -traditional forces PKCS#1
    if openssl genrsa -traditional -out "$RSA_KEY" 4096 2>/dev/null; then
        chmod 600 "$RSA_KEY"
        success "RSA key generated: $RSA_KEY"
        success "  Format: PKCS#1 (required by neatvnc)"
        success "  Size: 4096-bit"
    else
        error "Failed to generate RSA key"
        return 1
    fi
}

# ============================================================================
# CONFIG FILE CREATION
# ============================================================================

create_config() {
    local address=$1
    local port=$2

    info "Creating configuration file..."

    # Ensure config directory exists
    mkdir -p "$CONFIG_DIR"

    # Create config file
    cat > "$CONFIG_FILE" <<EOF
# WayVNC Configuration
# Generated by configure-wayvnc on $(date)

# Network binding
address=$address
port=$port

# Authentication and encryption
enable_auth=true
enable_pam=true

# TLS certificates
private_key_file=$TLS_KEY
certificate_file=$TLS_CERT

# RSA key for RSA-AES encryption (RealVNC / Apple VNC compatibility)
rsa_private_key_file=$RSA_KEY

# Optional: Uncomment to customize keyboard layout
# xkb_layout=us
# xkb_model=pc105
EOF

    success "Configuration file created: $CONFIG_FILE"
}

# ============================================================================
# FILE PERMISSIONS
# ============================================================================

set_permissions() {
    info "Setting secure file permissions..."

    # Config file: owner read/write only
    chmod 600 "$CONFIG_FILE"
    success "Set config permissions: 600 (owner read/write)"

    # Private key: owner read/write only
    chmod 600 "$TLS_KEY"
    success "Set TLS key permissions: 600 (owner read/write)"

    # RSA key: owner read/write only
    if [ -f "$RSA_KEY" ]; then
        chmod 600 "$RSA_KEY"
        success "Set RSA key permissions: 600 (owner read/write)"
    fi

    # Certificate: readable by all (certificates are public)
    chmod 644 "$TLS_CERT"
    success "Set certificate permissions: 644 (world readable)"
}

# ============================================================================
# GITIGNORE CREATION
# ============================================================================

create_gitignore() {
    if [ ! -f "$GITIGNORE_FILE" ]; then
        info "Creating .gitignore to protect secrets..."

        cat > "$GITIGNORE_FILE" <<EOF
# Actual configuration with credentials
config

# TLS certificates and keys
*.pem
*.key
*.crt

# Backup files
*.bak
*~
EOF

        success "Created .gitignore: $GITIGNORE_FILE"
    fi
}

# ============================================================================
# VERIFICATION
# ============================================================================

verify_config() {
    info "Verifying configuration..."

    # Check if config file exists and is readable
    if [ ! -r "$CONFIG_FILE" ]; then
        error "Config file is not readable"
        return 1
    fi

    # Check if certificates exist
    if [ ! -f "$TLS_KEY" ] || [ ! -f "$TLS_CERT" ]; then
        error "TLS certificates are missing"
        return 1
    fi

    # Check RSA key exists and is in correct format
    if [ -f "$RSA_KEY" ]; then
        if head -1 "$RSA_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            success "RSA key exists and is in PKCS#1 format"
        else
            warn "RSA key exists but may be in wrong format (expected PKCS#1)"
        fi
    else
        warn "RSA key not found (needed for RealVNC / Apple VNC clients)"
    fi

    success "Configuration appears valid"
}

# ============================================================================
# PAM CONFIGURATION SETUP
# ============================================================================

setup_pam_config() {
    info "Setting up PAM authentication configuration..."

    # Find the PAM config file in dotfiles
    # Script is at: wayvnc/.local/bin/configure-wayvnc
    # PAM file is at: wayvnc/pam.d/wayvnc
    local script_real_path
    script_real_path="$(readlink -f "$0")"
    # Get wayvnc module root (go up 2 levels: bin -> .local -> wayvnc)
    local module_root
    module_root="$(dirname "$(dirname "$(dirname "$script_real_path")")")"
    local pam_source="${module_root}/pam.d/wayvnc"

    if [ ! -f "$pam_source" ]; then
        error "PAM config not found: $pam_source"
        warn "This file should be part of the wayvnc module"
        return 1
    fi

    # Check if PAM config already exists
    if [ -f /etc/pam.d/wayvnc ]; then
        info "PAM config already exists at /etc/pam.d/wayvnc"

        # Check if it has known problematic configs
        local needs_update=0
        if grep -q "deny=3\|unlock_time=600" /etc/pam.d/wayvnc 2>/dev/null; then
            warn "Existing PAM config has invalid inline pam_faillock options"
            needs_update=1
        fi

        if [ $needs_update -eq 1 ]; then
            warn "PAM config needs to be updated for proper authentication"
            echo
            read -rp "Replace with fixed PAM config? (Recommended) (Y/n): " response </dev/tty
            if [[ "$response" =~ ^[Nn]$ ]]; then
                warn "Keeping old PAM config. VNC authentication may fail!"
                return 1
            fi
        else
            echo
            read -rp "Replace existing PAM config with latest version? (y/N): " response </dev/tty
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                info "Keeping existing PAM config"
                return 0
            fi
        fi
    else
        echo
        read -rp "Install PAM config to /etc/pam.d/wayvnc? (Required for authentication) (Y/n): " response </dev/tty
        if [[ "$response" =~ ^[Nn]$ ]]; then
            warn "Skipping PAM config installation"
            warn "VNC authentication will NOT work without this!"
            return 1
        fi
    fi

    # Install PAM config (requires sudo)
    info "Installing PAM config (requires sudo)..."
    if sudo cp "$pam_source" /etc/pam.d/wayvnc; then
        success "PAM config installed to /etc/pam.d/wayvnc"

        # Verify it was installed correctly
        if grep -q "pam_unix.so\|include.*system-auth" /etc/pam.d/wayvnc; then
            success "PAM config verified"
        else
            error "PAM config installation may have failed"
            return 1
        fi
    else
        error "Failed to install PAM config"
        return 1
    fi

    return 0
}

# ============================================================================
# SUDOERS SETUP
# ============================================================================

setup_sudoers() {
    info "Setting up sudoers rule for wayvnc..."

    local sudoers_file="/etc/sudoers.d/wayvnc"
    local sudoers_content
    sudoers_content="$(cat <<EOF
# Allow user to run wayvnc as root without password for VNC server
# Preserve Wayland session variables so wayvnc can connect to the compositor
Defaults!/usr/bin/wayvnc env_keep += "WAYLAND_DISPLAY XDG_RUNTIME_DIR"
${USER} ALL=(root) NOPASSWD: /usr/bin/wayvnc
EOF
)"

    # Check if sudoers file already exists with correct content
    if [ -f "$sudoers_file" ] && [ "$(sudo cat "$sudoers_file" 2>/dev/null)" = "$sudoers_content" ]; then
        success "Sudoers rule already configured for user $USER"
        return 0
    fi

    echo
    warn "WayVNC needs to run as root to read /etc/shadow for PAM authentication."
    warn "This will create a sudoers rule allowing passwordless 'sudo wayvnc'."
    warn "The rule is scoped to /usr/bin/wayvnc only."
    echo
    read -rp "Install sudoers rule for user $USER? (Required for PAM auth) (Y/n): " response </dev/tty
    if [[ "$response" =~ ^[Nn]$ ]]; then
        warn "Skipping sudoers setup"
        warn "PAM authentication will not work without this!"
        return 1
    fi

    # Write to temp file and validate before installing
    local tmpfile
    tmpfile="$(mktemp)"
    echo "$sudoers_content" > "$tmpfile"

    if ! sudo visudo -c -f "$tmpfile" &>/dev/null; then
        error "Sudoers syntax validation failed"
        rm -f "$tmpfile"
        return 1
    fi

    if sudo install -m 0440 -o root -g root "$tmpfile" "$sudoers_file"; then
        rm -f "$tmpfile"
        success "Sudoers rule installed: $sudoers_file"
    else
        rm -f "$tmpfile"
        error "Failed to install sudoers rule"
        return 1
    fi
}

# ============================================================================
# EXEC-ONCE SETUP
# ============================================================================

show_exec_once_setup() {
    echo
    info "Hyprland Integration"
    info "===================="
    echo
    info "This module provides a drop-in config at ~/.config/hypr/conf.d/wayvnc.conf"
    info "that starts wayvnc automatically via Hyprland's exec-once."
    echo
    info "If your hyprland.conf sources conf.d (source = ~/.config/hypr/conf.d/*.conf),"
    info "no manual configuration is needed. Just reload Hyprland or login again."
}

# ============================================================================
# NEXT STEPS
# ============================================================================

show_next_steps() {
    local address=$1

    echo
    success "WayVNC configuration complete!"
    echo
    info "Next steps:"
    echo

    echo "1. Deploy the module (stow) to install the Hyprland drop-in config:"
    echo "   cd ~/.local/share/dotfiles && ./install.sh"
    echo
    echo "2. Reload Hyprland or logout and login again"
    echo
    echo "3. Verify wayvnc is running:"
    echo "   pgrep -a wayvnc"
    echo
    echo "4. Stop wayvnc:"
    echo "   sudo pkill -x wayvnc"

    echo

    if [ "$address" = "127.0.0.1" ]; then
        echo "5. Connect from a remote machine using SSH tunnel:"
        echo "   ssh -L 5900:localhost:5900 $USER@$(hostname)"
        echo
        echo "6. Then connect your VNC client to:"
        echo "   localhost:5900"
    else
        echo "5. Ensure firewall allows port 5900:"
        echo "   sudo ufw allow 5900/tcp"
        echo
        echo "6. Connect your VNC client to:"
        echo "   $(hostname):5900"
    fi

    echo
    echo "7. Authenticate with your system credentials:"
    echo "   Username: $USER"
    echo "   Password: [your system password]"
    echo

    warn "Note: VNC clients may show certificate warnings (self-signed cert)"
    info "This is normal and expected. Accept the certificate to continue."
}

# ============================================================================
# QUICK SWITCH
# ============================================================================

quick_switch() {
    local address=$1
    local description=$2

    # Check if config exists
    if [ ! -f "$CONFIG_FILE" ]; then
        error "Config file not found: $CONFIG_FILE"
        error "Run configure-wayvnc without arguments to create initial config"
        exit 1
    fi

    info "Switching to $description ($address)..."

    # Get current port
    local port
    port=$(grep -E '^port=' "$CONFIG_FILE" | cut -d'=' -f2 | tr -d ' ')
    port=${port:-5900}

    # Backup current config
    cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

    # Update address in config
    sed -i "s/^address=.*/address=$address/" "$CONFIG_FILE"

    success "Configuration updated"

    # Restart wayvnc if it's running
    if pgrep -x wayvnc &>/dev/null; then
        info "Restarting wayvnc..."
        sudo pkill -x wayvnc || true
        sleep 1
        sudo /usr/bin/wayvnc --log-level=trace -C "$CONFIG_FILE" &
        disown
        sleep 2
        if pgrep -x wayvnc &>/dev/null; then
            success "WayVNC restarted successfully"
            echo
            info "WayVNC is now listening on: $address:$port"
        else
            error "WayVNC failed to start. Try running manually:"
            echo "  sudo /usr/bin/wayvnc --log-level=trace -C $CONFIG_FILE"
            exit 1
        fi
    else
        warn "WayVNC not running. Start it with:"
        echo "  start-wayvnc &"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    # Handle quick-switch arguments
    case "${1:-}" in
        --localhost|--local|-l)
            quick_switch "127.0.0.1" "localhost only"
            exit 0
            ;;
        --all|--any|-a)
            quick_switch "0.0.0.0" "all interfaces"
            exit 0
            ;;
        --help|-h)
            cat << 'EOF'
Usage: configure-wayvnc [OPTIONS]

Setup WayVNC with PAM authentication, TLS encryption, and RSA-AES support.

The setup wizard will:
  - Generate TLS certificates (with LAN IP SANs)
  - Generate RSA key in PKCS#1 format (for RealVNC / Apple VNC)
  - Create wayvnc configuration file
  - Install PAM config to /etc/pam.d/wayvnc
  - Install sudoers rule for passwordless sudo wayvnc
  - Show Hyprland exec-once configuration

Options:
  --localhost, --local, -l    Quick switch to localhost (127.0.0.1)
  --all, --any, -a           Quick switch to all interfaces (0.0.0.0)
  --help, -h                 Show this help message
  (no options)               Interactive setup wizard

Examples:
  configure-wayvnc              # Run interactive setup
  configure-wayvnc --localhost  # Switch to localhost binding
  configure-wayvnc --all        # Switch to all interfaces

EOF
            exit 0
            ;;
        --*)
            error "Unknown option: $1"
            echo "Run 'configure-wayvnc --help' for usage information"
            exit 1
            ;;
    esac

    # Interactive mode
    echo
    info "WayVNC Configuration Setup"
    info "=========================="
    echo

    # Check dependencies
    check_dependencies
    verify_pam_support

    # Check existing configuration
    local regenerate_certs=0
    if check_existing_config; then
        regenerate_certs=1
    fi

    # Get network configuration
    read -r address port < <(prompt_network_config)

    # Generate certificates if needed
    if [ $regenerate_certs -eq 1 ]; then
        generate_certificates
    fi

    # Generate RSA key for RSA-AES encryption (RealVNC compatibility)
    generate_rsa_key

    # Create configuration
    create_config "$address" "$port"

    # Set secure permissions
    set_permissions

    # Create .gitignore
    create_gitignore

    # Verify configuration
    verify_config

    # Setup PAM configuration (required for authentication)
    echo
    setup_pam_config

    # Setup sudoers rule (required for running wayvnc as root)
    echo
    setup_sudoers

    # Show Hyprland exec-once instructions
    show_exec_once_setup

    # Offer to start wayvnc now
    echo
    read -rp "Start wayvnc now? (Y/n): " response </dev/tty
    if [[ ! "$response" =~ ^[Nn]$ ]]; then
        info "Starting wayvnc..."
        sudo /usr/bin/wayvnc --log-level=trace -C "$CONFIG_FILE" &
        disown
        sleep 2
        if pgrep -x wayvnc &>/dev/null; then
            success "WayVNC is running"
        else
            warn "WayVNC may have failed to start. Try running manually:"
            echo "  start-wayvnc"
        fi
    fi

    # Show next steps
    show_next_steps "$address"
}

# Run main function
main "$@"
