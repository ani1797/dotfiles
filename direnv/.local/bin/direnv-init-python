#!/usr/bin/env bash
# direnv-init-python - Initialize direnv for Python projects
# Works from any shell (bash/zsh/fish) due to shebang

set -euo pipefail

# shellcheck source=direnv-lib
source "$(dirname "$0")/direnv-lib"

# Check if this looks like a Python project
is_python_project() {
    [[ -f pyproject.toml ]] || [[ -f setup.py ]] ||
    [[ -f requirements.txt ]] || [[ -f Pipfile ]] ||
    [[ -f setup.cfg ]] || [[ -d src ]]
}

check_direnv

# Check if UV is installed
if ! command -v uv >/dev/null 2>&1; then
    warn "uv not installed. Install: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

handle_existing_envrc

# Detect project type
if ! is_python_project; then
    warn "Current directory doesn't look like a Python project"
    info "Looking for: pyproject.toml, setup.py, requirements.txt, etc."
    echo
    read -p "Create .envrc anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "Aborted"
        exit 0
    fi
fi

echo "Creating .envrc with layout uv"
write_envrc '# Automatically load Python environment with UV
layout uv'

success ".envrc created"
echo
info "The virtual environment will be created automatically when you cd into this directory"
info "To manually create it now: direnv reload"
