#!/usr/bin/env bash
# configure-wayvnc - Setup WayVNC with PAM authentication and TLS encryption
# Generates TLS certificates and creates secure configuration file

set -euo pipefail

# ============================================================================
# CONSTANTS
# ============================================================================

readonly CONFIG_DIR="${HOME}/.config/wayvnc"
readonly CONFIG_FILE="${CONFIG_DIR}/config"
readonly EXAMPLE_FILE="${CONFIG_DIR}/config.example"
readonly TLS_KEY="${CONFIG_DIR}/tls_key.pem"
readonly TLS_CERT="${CONFIG_DIR}/tls_cert.pem"
readonly RSA_KEY="${CONFIG_DIR}/rsa_key.pem"
readonly GITIGNORE_FILE="${CONFIG_DIR}/.gitignore"

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# ============================================================================
# LOGGING FUNCTIONS
# ============================================================================

info() {
    echo -e "${BLUE}[configure-wayvnc]${NC} $*"
}

success() {
    echo -e "${GREEN}✓${NC} $*"
}

error() {
    echo -e "${RED}✗${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}!${NC} $*"
}

# ============================================================================
# DEPENDENCY CHECKING
# ============================================================================

check_dependencies() {
    info "Checking dependencies..."

    local missing_deps=()

    # Check for wayvnc
    if ! command -v wayvnc &> /dev/null; then
        missing_deps+=("wayvnc")
    fi

    # Check for openssl
    if ! command -v openssl &> /dev/null; then
        missing_deps+=("openssl")
    fi

    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing required dependencies: ${missing_deps[*]}"
        info "Please install them using your package manager:"
        info "  sudo pacman -S ${missing_deps[*]}"
        exit 1
    fi

    success "All dependencies found"
}

verify_pam_support() {
    info "Verifying PAM support in wayvnc..."

    if ldd "$(which wayvnc)" 2>/dev/null | grep -q libpam; then
        success "PAM support detected in wayvnc"
        return 0
    else
        error "Your wayvnc installation does not have PAM support"
        error "PAM authentication will not work"
        warn "Consider reinstalling wayvnc with PAM support enabled"

        # Ask if user wants to continue anyway
        echo
        read -rp "Continue anyway? (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Aborted by user"
            exit 0
        fi
    fi
}

# ============================================================================
# CONFIGURATION
# ============================================================================

check_existing_config() {
    if [ -f "$CONFIG_FILE" ]; then
        warn "Configuration file already exists: $CONFIG_FILE"
        echo
        read -rp "Reconfigure? This will backup the existing config. (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Keeping existing configuration"
            exit 0
        fi

        # Backup existing config
        local backup="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$CONFIG_FILE" "$backup"
        success "Backed up existing config to: $backup"
    fi

    if [ -f "$TLS_KEY" ] || [ -f "$TLS_CERT" ]; then
        warn "Existing TLS certificates found"
        echo
        read -rp "Regenerate certificates? (y/N): " response </dev/tty
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            info "Keeping existing certificates"
            return 1
        fi

        # Backup existing certificates
        if [ -f "$TLS_KEY" ]; then
            local key_backup="${TLS_KEY}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$TLS_KEY" "$key_backup"
        fi
        if [ -f "$TLS_CERT" ]; then
            local cert_backup="${TLS_CERT}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$TLS_CERT" "$cert_backup"
        fi
        success "Backed up existing certificates"
    fi

    return 0
}

prompt_network_config() {
    echo >&2
    info "Network Configuration" >&2
    echo >&2
    echo "Choose binding address:" >&2
    echo "  1) 0.0.0.0 (all interfaces - RECOMMENDED for LAN access)" >&2
    echo "     Allows VNC connections from other machines on the network" >&2
    echo "  2) 127.0.0.1 (localhost only)" >&2
    echo "     Remote access only via SSH tunnel: ssh -L 5900:localhost:5900 user@host" >&2
    echo >&2

    local address="0.0.0.0"
    read -rp "Enter choice [1]: " choice </dev/tty

    if [ "$choice" = "2" ]; then
        address="127.0.0.1"
        info "Using localhost binding (SSH tunnel required for remote access)" >&2
    else
        success "Binding to all interfaces for LAN access" >&2
        warn "Ensure your firewall is configured properly!" >&2
    fi

    echo >&2
    read -rp "Enter VNC port [5900]: " port </dev/tty
    port=${port:-5900}

    echo "$address $port"
}

# ============================================================================
# TLS CERTIFICATE GENERATION
# ============================================================================

generate_certificates() {
    info "Generating TLS certificates..."

    # Ensure config directory exists
    mkdir -p "$CONFIG_DIR"

    # Build SAN list including local network IPs for LAN access
    local san_list="DNS:localhost,IP:127.0.0.1"

    if command -v ip &>/dev/null; then
        local local_ips
        local_ips=$(ip -4 addr show 2>/dev/null | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | sort -u)
        if [ -n "$local_ips" ]; then
            while IFS= read -r addr; do
                san_list="${san_list},IP:${addr}"
                info "  Including LAN IP in certificate: $addr"
            done <<< "$local_ips"
        fi
    fi

    local hostname_fqdn
    hostname_fqdn=$(hostname -f 2>/dev/null || hostname)
    if [ "$hostname_fqdn" != "localhost" ]; then
        san_list="${san_list},DNS:${hostname_fqdn}"
    fi

    # Generate elliptic curve certificate (modern, secure, fast)
    if openssl req -x509 -newkey ec -pkeyopt ec_paramgen_curve:secp384r1 \
        -sha384 -days 3650 -nodes \
        -keyout "$TLS_KEY" \
        -out "$TLS_CERT" \
        -subj /CN=localhost \
        -addext "subjectAltName=${san_list}" 2>/dev/null; then

        success "TLS certificates generated successfully"
        success "  Private key: $TLS_KEY"
        success "  Certificate: $TLS_CERT"
        success "  Valid for: 10 years"
    else
        error "Failed to generate TLS certificates"
        exit 1
    fi
}

# ============================================================================
# RSA KEY GENERATION
# ============================================================================

generate_rsa_key() {
    info "Generating RSA key for RSA-AES encryption..."

    if [ -f "$RSA_KEY" ]; then
        # Check if existing key is in the correct PKCS#1 format
        if head -1 "$RSA_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            success "RSA key already exists in correct format: $RSA_KEY"
            return 0
        else
            warn "Existing RSA key is in wrong format (PKCS#8), regenerating..."
            local backup="${RSA_KEY}.backup.$(date +%Y%m%d_%H%M%S)"
            cp "$RSA_KEY" "$backup"
        fi
    fi

    # Generate RSA key in PKCS#1 format (required by neatvnc)
    # OpenSSL 3.x defaults to PKCS#8 format, -traditional forces PKCS#1
    if openssl genrsa -traditional -out "$RSA_KEY" 4096 2>/dev/null; then
        chmod 600 "$RSA_KEY"
        success "RSA key generated: $RSA_KEY"
        success "  Format: PKCS#1 (required by neatvnc)"
        success "  Size: 4096-bit"
    else
        error "Failed to generate RSA key"
        return 1
    fi
}

# ============================================================================
# CONFIG FILE CREATION
# ============================================================================

create_config() {
    local address=$1
    local port=$2

    info "Creating configuration file..."

    # Ensure config directory exists
    mkdir -p "$CONFIG_DIR"

    # Create config file
    cat > "$CONFIG_FILE" <<EOF
# WayVNC Configuration
# Generated by configure-wayvnc on $(date)

# Network binding
address=$address
port=$port

# Authentication and encryption
enable_auth=true
enable_pam=true

# TLS certificates (absolute paths for systemd compatibility)
private_key_file=$TLS_KEY
certificate_file=$TLS_CERT

# RSA key for RSA-AES encryption (RealVNC / Apple VNC compatibility)
rsa_private_key_file=$RSA_KEY

# Optional: Uncomment to customize keyboard layout
# xkb_layout=us
# xkb_model=pc105
EOF

    success "Configuration file created: $CONFIG_FILE"
}

# ============================================================================
# FILE PERMISSIONS
# ============================================================================

set_permissions() {
    info "Setting secure file permissions..."

    # Config file: owner read/write only
    chmod 600 "$CONFIG_FILE"
    success "Set config permissions: 600 (owner read/write)"

    # Private key: owner read/write only
    chmod 600 "$TLS_KEY"
    success "Set TLS key permissions: 600 (owner read/write)"

    # RSA key: owner read/write only
    if [ -f "$RSA_KEY" ]; then
        chmod 600 "$RSA_KEY"
        success "Set RSA key permissions: 600 (owner read/write)"
    fi

    # Certificate: readable by all (certificates are public)
    chmod 644 "$TLS_CERT"
    success "Set certificate permissions: 644 (world readable)"
}

# ============================================================================
# GITIGNORE CREATION
# ============================================================================

create_gitignore() {
    if [ ! -f "$GITIGNORE_FILE" ]; then
        info "Creating .gitignore to protect secrets..."

        cat > "$GITIGNORE_FILE" <<EOF
# Actual configuration with credentials
config

# TLS certificates and keys
*.pem
*.key
*.crt

# Backup files
*.bak
*~
EOF

        success "Created .gitignore: $GITIGNORE_FILE"
    fi
}

# ============================================================================
# VERIFICATION
# ============================================================================

verify_config() {
    info "Verifying configuration..."

    # Check if config file exists and is readable
    if [ ! -r "$CONFIG_FILE" ]; then
        error "Config file is not readable"
        return 1
    fi

    # Check if certificates exist
    if [ ! -f "$TLS_KEY" ] || [ ! -f "$TLS_CERT" ]; then
        error "TLS certificates are missing"
        return 1
    fi

    # Check RSA key exists and is in correct format
    if [ -f "$RSA_KEY" ]; then
        if head -1 "$RSA_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            success "RSA key exists and is in PKCS#1 format"
        else
            warn "RSA key exists but may be in wrong format (expected PKCS#1)"
        fi
    else
        warn "RSA key not found (needed for RealVNC / Apple VNC clients)"
    fi

    success "Configuration appears valid"
}

# ============================================================================
# PAM CONFIGURATION SETUP
# ============================================================================

setup_pam_config() {
    info "Setting up PAM authentication configuration..."

    # Find the PAM config file in dotfiles
    # Script is at: wayvnc/.local/bin/configure-wayvnc
    # PAM file is at: wayvnc/pam.d/wayvnc
    local script_real_path
    script_real_path="$(readlink -f "$0")"
    # Get wayvnc module root (go up 2 levels: bin -> .local -> wayvnc)
    local module_root
    module_root="$(dirname "$(dirname "$(dirname "$script_real_path")")")"
    local pam_source="${module_root}/pam.d/wayvnc"

    if [ ! -f "$pam_source" ]; then
        error "PAM config not found: $pam_source"
        warn "This file should be part of the wayvnc module"
        return 1
    fi

    # Check if PAM config already exists
    if [ -f /etc/pam.d/wayvnc ]; then
        info "PAM config already exists at /etc/pam.d/wayvnc"

        # Check if it has known problematic configs
        local needs_update=0
        if grep -q "deny=3\|unlock_time=600" /etc/pam.d/wayvnc 2>/dev/null; then
            warn "Existing PAM config has invalid inline pam_faillock options"
            needs_update=1
        fi

        if [ $needs_update -eq 1 ]; then
            warn "PAM config needs to be updated for proper authentication"
            echo
            read -rp "Replace with fixed PAM config? (Recommended) (Y/n): " response </dev/tty
            if [[ "$response" =~ ^[Nn]$ ]]; then
                warn "Keeping old PAM config. VNC authentication may fail!"
                return 1
            fi
        else
            echo
            read -rp "Replace existing PAM config with latest version? (y/N): " response </dev/tty
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                info "Keeping existing PAM config"
                return 0
            fi
        fi
    else
        echo
        read -rp "Install PAM config to /etc/pam.d/wayvnc? (Required for authentication) (Y/n): " response </dev/tty
        if [[ "$response" =~ ^[Nn]$ ]]; then
            warn "Skipping PAM config installation"
            warn "VNC authentication will NOT work without this!"
            return 1
        fi
    fi

    # Install PAM config (requires sudo)
    info "Installing PAM config (requires sudo)..."
    if sudo cp "$pam_source" /etc/pam.d/wayvnc; then
        success "PAM config installed to /etc/pam.d/wayvnc"

        # Verify it was installed correctly
        if grep -q "pam_unix.so\|include.*system-auth" /etc/pam.d/wayvnc; then
            success "PAM config verified"
        else
            error "PAM config installation may have failed"
            return 1
        fi
    else
        error "Failed to install PAM config"
        return 1
    fi

    return 0
}

# ============================================================================
# SHADOW ACL SETUP
# ============================================================================

setup_shadow_acl() {
    info "Checking /etc/shadow access for PAM authentication..."

    # pam_unix.so normally uses the unix_chkpwd setuid helper to verify passwords
    # against /etc/shadow. However, this helper fails when forked from wayvnc's
    # multi-threaded process. Granting the user direct read access to /etc/shadow
    # via ACL lets pam_unix.so verify passwords without the helper.

    # Check if acl package is available
    if ! command -v getfacl &>/dev/null; then
        error "ACL utilities not found. Install the 'acl' package:"
        error "  sudo pacman -S acl"
        return 1
    fi

    # Check if user already has read access via ACL
    if getfacl -p /etc/shadow 2>/dev/null | grep -q "user:${USER}:r"; then
        success "Shadow ACL already set for user $USER"
        return 0
    fi

    echo
    warn "PAM authentication requires read access to /etc/shadow"
    warn "The unix_chkpwd setuid helper fails from wayvnc's multi-threaded process."
    warn "Setting an ACL grants your user direct read access as a workaround."
    echo
    read -rp "Set shadow ACL for user $USER? (Required for PAM auth) (Y/n): " response </dev/tty
    if [[ "$response" =~ ^[Nn]$ ]]; then
        warn "Skipping shadow ACL setup"
        warn "PAM authentication will likely fail without this!"
        return 1
    fi

    if sudo setfacl -m "u:${USER}:r" /etc/shadow; then
        success "Shadow ACL set: user:${USER}:r-- on /etc/shadow"

        # Verify
        if getfacl -p /etc/shadow 2>/dev/null | grep -q "user:${USER}:r"; then
            success "Shadow ACL verified"
        else
            error "Shadow ACL verification failed"
            return 1
        fi
    else
        error "Failed to set shadow ACL"
        return 1
    fi
}

# ============================================================================
# SYSTEMD SERVICE SETUP
# ============================================================================

setup_systemd_service() {
    info "Setting up systemd user service..."

    # Check if service file exists
    if [ ! -f "$HOME/.config/systemd/user/wayvnc.service" ]; then
        error "Service file not found. Did you deploy the wayvnc module?"
        warn "Run: ./install.sh (from your dotfiles directory)"
        return 1
    fi

    # Reload systemd user daemon
    if systemctl --user daemon-reload; then
        success "Reloaded systemd user daemon"
    else
        error "Failed to reload systemd daemon"
        return 1
    fi

    # Prompt to enable service
    echo
    read -rp "Enable wayvnc service to start on login? (Y/n): " response </dev/tty
    if [[ ! "$response" =~ ^[Nn]$ ]]; then
        if systemctl --user enable wayvnc.service 2>/dev/null; then
            success "Enabled wayvnc.service"
        else
            error "Failed to enable wayvnc.service"
            return 1
        fi
    fi

    # Prompt to start service now
    echo
    read -rp "Start wayvnc service now? (Y/n): " response </dev/tty
    if [[ ! "$response" =~ ^[Nn]$ ]]; then
        if systemctl --user start wayvnc.service 2>/dev/null; then
            success "Started wayvnc.service"

            # Wait a moment and check status
            sleep 2
            if systemctl --user is-active --quiet wayvnc.service; then
                success "WayVNC is running"
                echo
                info "Service status:"
                systemctl --user status wayvnc.service --no-pager -l
            else
                warn "WayVNC failed to start. Check status:"
                echo "  systemctl --user status wayvnc.service"
                echo "  journalctl --user -u wayvnc.service -n 50"
                return 1
            fi
        else
            error "Failed to start wayvnc.service"
            return 1
        fi
    fi

    return 0
}

# ============================================================================
# NEXT STEPS
# ============================================================================

show_next_steps() {
    local address=$1
    local using_systemd=$2

    echo
    success "WayVNC configuration complete!"
    echo
    info "Next steps:"
    echo

    if [ "$using_systemd" = "1" ]; then
        echo "1. Service management commands:"
        echo "   systemctl --user status wayvnc.service   # Check status"
        echo "   systemctl --user stop wayvnc.service     # Stop service"
        echo "   systemctl --user restart wayvnc.service  # Restart service"
        echo "   journalctl --user -u wayvnc.service -f   # View logs"
        echo
        echo "2. Verify wayvnc is running:"
        echo "   systemctl --user is-active wayvnc.service"
    else
        echo "1. Restart Hyprland to apply changes:"
        echo "   - Logout and login again, OR"
        echo "   - Run: hyprctl reload"
        echo
        echo "2. Verify wayvnc is running:"
        echo "   ps aux | grep wayvnc"
    fi

    echo

    if [ "$address" = "127.0.0.1" ]; then
        echo "3. Connect from a remote machine using SSH tunnel:"
        echo "   ssh -L 5900:localhost:5900 $USER@$(hostname)"
        echo
        echo "4. Then connect your VNC client to:"
        echo "   localhost:5900"
    else
        echo "3. Ensure firewall allows port 5900:"
        echo "   sudo ufw allow 5900/tcp"
        echo
        echo "4. Connect your VNC client to:"
        echo "   $(hostname):5900"
    fi

    echo
    echo "5. Authenticate with your system credentials:"
    echo "   Username: $USER"
    echo "   Password: [your system password]"
    echo

    warn "Note: VNC clients may show certificate warnings (self-signed cert)"
    info "This is normal and expected. Accept the certificate to continue."
    echo

    info "For more information, see: ~/.config/wayvnc/config.example"
    info "Or read: $(dirname "$(readlink -f "$0")")/../README.md"
}

# ============================================================================
# QUICK SWITCH
# ============================================================================

quick_switch() {
    local address=$1
    local description=$2

    # Check if config exists
    if [ ! -f "$CONFIG_FILE" ]; then
        error "Config file not found: $CONFIG_FILE"
        error "Run configure-wayvnc without arguments to create initial config"
        exit 1
    fi

    info "Switching to $description ($address)..."

    # Get current port
    local port
    port=$(grep -E '^port=' "$CONFIG_FILE" | cut -d'=' -f2 | tr -d ' ')
    port=${port:-5900}

    # Backup current config
    cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

    # Update address in config
    sed -i "s/^address=.*/address=$address/" "$CONFIG_FILE"

    success "Configuration updated"

    # Restart service if it's running
    if systemctl --user is-active --quiet wayvnc.service 2>/dev/null; then
        info "Restarting wayvnc service..."
        if systemctl --user restart wayvnc.service; then
            sleep 1
            if systemctl --user is-active --quiet wayvnc.service; then
                success "Service restarted successfully"
                echo
                info "WayVNC is now listening on: $address:$port"
            else
                error "Service failed to start. Check logs:"
                echo "  journalctl --user -u wayvnc.service -n 20"
                exit 1
            fi
        else
            error "Failed to restart service"
            exit 1
        fi
    else
        warn "Service not running. Start it with:"
        echo "  systemctl --user start wayvnc.service"
    fi
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    # Handle quick-switch arguments
    case "${1:-}" in
        --localhost|--local|-l)
            quick_switch "127.0.0.1" "localhost only"
            exit 0
            ;;
        --all|--any|-a)
            quick_switch "0.0.0.0" "all interfaces"
            exit 0
            ;;
        --help|-h)
            cat << 'EOF'
Usage: configure-wayvnc [OPTIONS]

Setup WayVNC with PAM authentication, TLS encryption, and RSA-AES support.

The setup wizard will:
  - Generate TLS certificates (with LAN IP SANs)
  - Generate RSA key in PKCS#1 format (for RealVNC / Apple VNC)
  - Create wayvnc configuration file
  - Install PAM config to /etc/pam.d/wayvnc
  - Set /etc/shadow ACL for PAM authentication
  - Configure systemd user service

Options:
  --localhost, --local, -l    Quick switch to localhost (127.0.0.1)
  --all, --any, -a           Quick switch to all interfaces (0.0.0.0)
  --help, -h                 Show this help message
  (no options)               Interactive setup wizard

Examples:
  configure-wayvnc              # Run interactive setup
  configure-wayvnc --localhost  # Switch to localhost binding
  configure-wayvnc --all        # Switch to all interfaces

EOF
            exit 0
            ;;
        --*)
            error "Unknown option: $1"
            echo "Run 'configure-wayvnc --help' for usage information"
            exit 1
            ;;
    esac

    # Interactive mode
    echo
    info "WayVNC Configuration Setup"
    info "=========================="
    echo

    # Check dependencies
    check_dependencies
    verify_pam_support

    # Check existing configuration
    local regenerate_certs=0
    if check_existing_config; then
        regenerate_certs=1
    fi

    # Get network configuration
    read -r address port < <(prompt_network_config)

    # Generate certificates if needed
    if [ $regenerate_certs -eq 1 ]; then
        generate_certificates
    fi

    # Generate RSA key for RSA-AES encryption (RealVNC compatibility)
    generate_rsa_key

    # Create configuration
    create_config "$address" "$port"

    # Set secure permissions
    set_permissions

    # Create .gitignore
    create_gitignore

    # Verify configuration
    verify_config

    # Setup PAM configuration (required for authentication)
    echo
    setup_pam_config

    # Setup shadow ACL (required for PAM auth from wayvnc)
    echo
    setup_shadow_acl

    # Setup systemd service (optional)
    local using_systemd=0
    if command -v systemctl &> /dev/null; then
        echo
        info "Systemd detected - can manage wayvnc as a user service"
        echo
        read -rp "Setup systemd service? (Recommended) (Y/n): " response </dev/tty
        if [[ ! "$response" =~ ^[Nn]$ ]]; then
            if setup_systemd_service; then
                using_systemd=1
            else
                warn "Systemd setup failed, will use Hyprland exec-once instead"
            fi
        else
            info "Skipping systemd setup. Will use Hyprland exec-once."
        fi
    fi

    # Show next steps
    show_next_steps "$address" "$using_systemd"
}

# Run main function
main "$@"
